// Chosen, a Select Box Enhancer for jQuery and Protoype
// by Patrick Filler for Harvest, http://getharvest.com
//
// Version 0.9.12
// Full source at https://github.com/harvesthq/chosen
// Copyright (c) 2011 Harvest http://getharvest.com

// MIT License, https://github.com/harvesthq/chosen/blob/master/LICENSE.md
// This file is generated by `cake build`, do not edit it by hand.
(function(){var e;e=function(){function e(){this.options_index=0,this.parsed=[]}return e.prototype.add_node=function(e){return e.nodeName.toUpperCase()==="OPTGROUP"?this.add_group(e):this.add_option(e)},e.prototype.add_group=function(e){var t,n,r,i,s,o;t=this.parsed.length,this.parsed.push({array_index:t,group:!0,label:e.label,children:0,disabled:e.disabled}),s=e.childNodes,o=[];for(r=0,i=s.length;r<i;r++)n=s[r],o.push(this.add_option(n,t,e.disabled));return o},e.prototype.add_option=function(e,t,n){if(e.nodeName.toUpperCase()==="OPTION")return e.text!==""?(t!=null&&(this.parsed[t].children+=1),this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,value:e.value,text:e.text,html:e.innerHTML,selected:e.selected,disabled:n===!0?n:e.disabled,group_array_index:t,classes:e.className,style:e.style.cssText})):this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,empty:!0}),this.options_index+=1},e}(),e.select_to_array=function(t){var n,r,i,s,o;r=new e,o=t.childNodes;for(i=0,s=o.length;i<s;i++)n=o[i],r.add_node(n);return r.parsed},this.SelectParser=e}).call(this),function(){var e,t;t=this,e=function(){function e(e,t){this.form_field=e,this.options=t!=null?t:{},this.is_multiple=this.form_field.multiple,this.set_default_text(),this.set_default_values(),this.setup(),this.set_up_html(),this.register_observers(),this.finish_setup()}return e.prototype.set_default_values=function(){var e=this;return this.click_test_action=function(t){return e.test_active_click(t)},this.activate_action=function(t){return e.activate_field(t)},this.active_field=!1,this.mouse_on_container=!1,this.results_showing=!1,this.result_highlighted=null,this.result_single_selected=null,this.allow_single_deselect=this.options.allow_single_deselect!=null&&this.form_field.options[0]!=null&&this.form_field.options[0].text===""?this.options.allow_single_deselect:!1,this.disable_search_threshold=this.options.disable_search_threshold||0,this.disable_search=this.options.disable_search||!1,this.enable_split_word_search=this.options.enable_split_word_search!=null?this.options.enable_split_word_search:!0,this.search_contains=this.options.search_contains||!1,this.choices=0,this.single_backstroke_delete=this.options.single_backstroke_delete||!1,this.max_selected_options=this.options.max_selected_options||Infinity,this.inherit_select_classes=this.options.inherit_select_classes||!1},e.prototype.set_default_text=function(){return this.form_field.getAttribute("data-placeholder")?this.default_text=this.form_field.getAttribute("data-placeholder"):this.is_multiple?this.default_text=this.options.placeholder_text_multiple||this.options.placeholder_text||"Select Some Options":this.default_text=this.options.placeholder_text_single||this.options.placeholder_text||"Select an Option",this.results_none_found=this.form_field.getAttribute("data-no_results_text")||this.options.no_results_text||"No results match"},e.prototype.mouse_enter=function(){return this.mouse_on_container=!0},e.prototype.mouse_leave=function(){return this.mouse_on_container=!1},e.prototype.input_focus=function(e){var t=this;if(this.is_multiple){if(!this.active_field)return setTimeout(function(){return t.container_mousedown()},50)}else if(!this.active_field)return this.activate_field()},e.prototype.input_blur=function(e){var t=this;if(!this.mouse_on_container)return this.active_field=!1,setTimeout(function(){return t.blur_test()},100)},e.prototype.result_add_option=function(e){var t,n;return e.disabled?"":(e.dom_id=this.container_id+"_o_"+e.array_index,t=e.selected&&this.is_multiple?[]:["active-result"],e.selected&&t.push("result-selected"),e.group_array_index!=null&&t.push("group-option"),e.classes!==""&&t.push(e.classes),n=e.style.cssText!==""?' style="'+e.style+'"':"",'<li id="'+e.dom_id+'" class="'+t.join(" ")+'"'+n+">"+e.html+"</li>")},e.prototype.results_update_field=function(){return this.set_default_text(),this.is_multiple||this.results_reset_cleanup(),this.result_clear_highlight(),this.result_single_selected=null,this.results_build()},e.prototype.results_toggle=function(){return this.results_showing?this.results_hide():this.results_show()},e.prototype.results_search=function(e){return this.results_showing?this.winnow_results():this.results_show()},e.prototype.keyup_checker=function(e){var t,n;t=(n=e.which)!=null?n:e.keyCode,this.search_field_scale();switch(t){case 8:if(this.is_multiple&&this.backstroke_length<1&&this.choices>0)return this.keydown_backstroke();if(!this.pending_backstroke)return this.result_clear_highlight(),this.results_search();break;case 13:e.preventDefault();if(this.results_showing)return this.result_select(e);break;case 27:return this.results_showing&&this.results_hide(),!0;case 9:case 38:case 40:case 16:case 91:case 17:break;default:return this.results_search()}},e.prototype.generate_field_id=function(){var e;return e=this.generate_random_id(),this.form_field.id=e,e},e.prototype.generate_random_char=function(){var e,t,n;return e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",n=Math.floor(Math.random()*e.length),t=e.substring(n,n+1)},e}(),t.AbstractChosen=e}.call(this),function(){var e,t,n,r,i={}.hasOwnProperty,s=function(e,t){function r(){this.constructor=e}for(var n in t)i.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};r=this,e=jQuery,e.fn.extend({chosen:function(n){var r,i,s;return s=navigator.userAgent.toLowerCase(),i=/(msie) ([\w.]+)/.exec(s)||[],r={name:i[1]||"",version:i[2]||"0"},r.name==="msie"&&(r.version==="6.0"||r.version==="7.0"&&document.documentMode===7)?this:this.each(function(r){var i;i=e(this);if(!i.hasClass("chzn-done"))return i.data("chosen",new t(this,n))})}}),t=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return s(i,t),i.prototype.setup=function(){return this.form_field_jq=e(this.form_field),this.current_value=this.form_field_jq.val(),this.is_rtl=this.form_field_jq.hasClass("chzn-rtl")},i.prototype.finish_setup=function(){return this.form_field_jq.addClass("chzn-done")},i.prototype.set_up_html=function(){var t,r,i,s,o,u;return this.container_id=this.form_field.id.length?this.form_field.id.replace(/[^\w]/g,"_"):this.generate_field_id(),this.container_id+="_chzn",t=["chzn-container"],t.push("chzn-container-"+(this.is_multiple?"multi":"single")),this.inherit_select_classes&&this.form_field.className&&t.push(this.form_field.className),this.is_rtl&&t.push("chzn-rtl"),this.f_width=this.form_field_jq.outerWidth(),i={id:this.container_id,"class":t.join(" "),style:"width: "+this.f_width+"px;",title:this.form_field.title},r=e("<div />",i),this.is_multiple?r.html('<ul class="chzn-choices"><li class="search-field"><input type="text" value="'+this.default_text+'" class="default" autocomplete="off" style="width:25px;" /></li></ul><div class="chzn-drop" style="left:-9000px;"><ul class="chzn-results"></ul></div>'):r.html('<a href="javascript:void(0)" class="chzn-single chzn-default" tabindex="-1"><span>'+this.default_text+'</span><div><b></b></div></a><div class="chzn-drop" style="left:-9000px;"><div class="chzn-search"><input type="text" autocomplete="off" /></div><ul class="chzn-results"></ul></div>'),this.form_field_jq.hide().after(r),this.container=e("#"+this.container_id),this.dropdown=this.container.find("div.chzn-drop").first(),s=this.container.height(),o=this.f_width-n(this.dropdown),this.dropdown.css({width:o+"px",top:s+"px"}),this.search_field=this.container.find("input").first(),this.search_results=this.container.find("ul.chzn-results").first(),this.search_field_scale(),this.search_no_results=this.container.find("li.no-results").first(),this.is_multiple?(this.search_choices=this.container.find("ul.chzn-choices").first(),this.search_container=this.container.find("li.search-field").first()):(this.search_container=this.container.find("div.chzn-search").first(),this.selected_item=this.container.find(".chzn-single").first(),u=o-n(this.search_container)-n(this.search_field),this.search_field.css({width:u+"px"})),this.results_build(),this.set_tab_index(),this.form_field_jq.trigger("liszt:ready",{chosen:this})},i.prototype.register_observers=function(){var e=this;return this.container.mousedown(function(t){e.container_mousedown(t)}),this.container.mouseup(function(t){e.container_mouseup(t)}),this.container.mouseenter(function(t){e.mouse_enter(t)}),this.container.mouseleave(function(t){e.mouse_leave(t)}),this.search_results.mouseup(function(t){e.search_results_mouseup(t)}),this.search_results.mouseover(function(t){e.search_results_mouseover(t)}),this.search_results.mouseout(function(t){e.search_results_mouseout(t)}),this.form_field_jq.bind("liszt:updated",function(t){e.results_update_field(t)}),this.form_field_jq.bind("liszt:activate",function(t){e.activate_field(t)}),this.form_field_jq.bind("liszt:open",function(t){e.container_mousedown(t)}),this.search_field.blur(function(t){e.input_blur(t)}),this.search_field.keyup(function(t){e.keyup_checker(t)}),this.search_field.keydown(function(t){e.keydown_checker(t)}),this.search_field.focus(function(t){e.input_focus(t)}),this.is_multiple?this.search_choices.click(function(t){e.choices_click(t)}):this.container.click(function(e){e.preventDefault()})},i.prototype.search_field_disabled=function(){this.is_disabled=this.form_field_jq[0].disabled;if(this.is_disabled)return this.container.addClass("chzn-disabled"),this.search_field[0].disabled=!0,this.is_multiple||this.selected_item.unbind("focus",this.activate_action),this.close_field();this.container.removeClass("chzn-disabled"),this.search_field[0].disabled=!1;if(!this.is_multiple)return this.selected_item.bind("focus",this.activate_action)},i.prototype.container_mousedown=function(t){var n;if(!this.is_disabled)return n=t!=null?e(t.target).hasClass("search-choice-close"):!1,t&&t.type==="mousedown"&&!this.results_showing&&t.preventDefault(),!this.pending_destroy_click&&!n?(this.active_field?!this.is_multiple&&t&&(e(t.target)[0]===this.selected_item[0]||e(t.target).parents("a.chzn-single").length)&&(t.preventDefault(),this.results_toggle()):(this.is_multiple&&this.search_field.val(""),e(document).click(this.click_test_action),this.results_show()),this.activate_field()):this.pending_destroy_click=!1},i.prototype.container_mouseup=function(e){if(e.target.nodeName==="ABBR"&&!this.is_disabled)return this.results_reset(e)},i.prototype.blur_test=function(e){if(!this.active_field&&this.container.hasClass("chzn-container-active"))return this.close_field()},i.prototype.close_field=function(){return e(document).unbind("click",this.click_test_action),this.active_field=!1,this.results_hide(),this.container.removeClass("chzn-container-active"),this.winnow_results_clear(),this.clear_backstroke(),this.show_search_field_default(),this.search_field_scale()},i.prototype.activate_field=function(){return this.container.addClass("chzn-container-active"),this.active_field=!0,this.search_field.val(this.search_field.val()),this.search_field.focus()},i.prototype.test_active_click=function(t){return e(t.target).parents("#"+this.container_id).length?this.active_field=!0:this.close_field()},i.prototype.results_build=function(){var e,t,n,i,s;this.parsing=!0,this.results_data=r.SelectParser.select_to_array(this.form_field),this.is_multiple&&this.choices>0?(this.search_choices.find("li.search-choice").remove(),this.choices=0):this.is_multiple||(this.selected_item.addClass("chzn-default").find("span").text(this.default_text),this.disable_search||this.form_field.options.length<=this.disable_search_threshold?this.container.addClass("chzn-container-single-nosearch"):this.container.removeClass("chzn-container-single-nosearch")),e="",s=this.results_data;for(n=0,i=s.length;n<i;n++)t=s[n],t.group?e+=this.result_add_group(t):t.empty||(e+=this.result_add_option(t),t.selected&&this.is_multiple?this.choice_build(t):t.selected&&!this.is_multiple&&(this.selected_item.removeClass("chzn-default").find("span").text(t.text),this.allow_single_deselect&&this.single_deselect_control_build()));return this.search_field_disabled(),this.show_search_field_default(),this.search_field_scale(),this.search_results.html(e),this.parsing=!1},i.prototype.result_add_group=function(t){return t.disabled?"":(t.dom_id=this.container_id+"_g_"+t.array_index,'<li id="'+t.dom_id+'" class="group-result">'+e("<div />").text(t.label).html()+"</li>")},i.prototype.result_do_highlight=function(e){var t,n,r,i,s;if(e.length){this.result_clear_highlight(),this.result_highlight=e,this.result_highlight.addClass("highlighted"),r=parseInt(this.search_results.css("maxHeight"),10),s=this.search_results.scrollTop(),i=r+s,n=this.result_highlight.position().top+this.search_results.scrollTop(),t=n+this.result_highlight.outerHeight();if(t>=i)return this.search_results.scrollTop(t-r>0?t-r:0);if(n<s)return this.search_results.scrollTop(n)}},i.prototype.result_clear_highlight=function(){return this.result_highlight&&this.result_highlight.removeClass("highlighted"),this.result_highlight=null},i.prototype.results_show=function(){var e;if(!this.is_multiple)this.selected_item.addClass("chzn-single-with-drop"),this.result_single_selected&&this.result_do_highlight(this.result_single_selected);else if(this.max_selected_options<=this.choices)return this.form_field_jq.trigger("liszt:maxselected",{chosen:this}),!1;return e=this.is_multiple?this.container.height():this.container.height()-1,this.form_field_jq.trigger("liszt:showing_dropdown",{chosen:this}),this.dropdown.css({top:e+"px",left:0}),this.results_showing=!0,this.search_field.focus(),this.search_field.val(this.search_field.val()),this.winnow_results()},i.prototype.results_hide=function(){return this.is_multiple||this.selected_item.removeClass("chzn-single-with-drop"),this.result_clear_highlight(),this.form_field_jq.trigger("liszt:hiding_dropdown",{chosen:this}),this.dropdown.css({left:"-9000px"}),this.results_showing=!1},i.prototype.set_tab_index=function(e){var t;if(this.form_field_jq.attr("tabindex"))return t=this.form_field_jq.attr("tabindex"),this.form_field_jq.attr("tabindex",-1),this.search_field.attr("tabindex",t)},i.prototype.show_search_field_default=function(){return this.is_multiple&&this.choices<1&&!this.active_field?(this.search_field.val(this.default_text),this.search_field.addClass("default")):(this.search_field.val(""),this.search_field.removeClass("default"))},i.prototype.search_results_mouseup=function(t){var n;n=e(t.target).hasClass("active-result")?e(t.target):e(t.target).parents(".active-result").first();if(n.length)return this.result_highlight=n,this.result_select(t),this.search_field.focus()},i.prototype.search_results_mouseover=function(t){var n;n=e(t.target).hasClass("active-result")?e(t.target):e(t.target).parents(".active-result").first();if(n)return this.result_do_highlight(n)},i.prototype.search_results_mouseout=function(t){if(e(t.target).hasClass("active-result"))return this.result_clear_highlight()},i.prototype.choices_click=function(t){t.preventDefault();if(this.active_field&&!e(t.target).hasClass("search-choice")&&!this.results_showing)return this.results_show()},i.prototype.choice_build=function(t){var n,r,i,s=this;return this.is_multiple&&this.max_selected_options<=this.choices?(this.form_field_jq.trigger("liszt:maxselected",{chosen:this}),!1):(n=this.container_id+"_c_"+t.array_index,this.choices+=1,t.disabled?r='<li class="search-choice search-choice-disabled" id="'+n+'"><span>'+t.html+"</span></li>":r='<li class="search-choice" id="'+n+'"><span>'+t.html+'</span><a href="javascript:void(0)" class="search-choice-close" rel="'+t.array_index+'"></a></li>',this.search_container.before(r),i=e("#"+n).find("a").first(),i.click(function(e){return s.choice_destroy_link_click(e)}))},i.prototype.choice_destroy_link_click=function(t){return t.preventDefault(),this.is_disabled?t.stopPropagation:(this.pending_destroy_click=!0,this.choice_destroy(e(t.target)))},i.prototype.choice_destroy=function(e){if(this.result_deselect(e.attr("rel")))return this.choices-=1,this.show_search_field_default(),this.is_multiple&&this.choices>0&&this.search_field.val().length<1&&this.results_hide(),e.parents("li").first().remove(),this.search_field_scale()},i.prototype.results_reset=function(){this.form_field.options[0].selected=!0,this.selected_item.find("span").text(this.default_text),this.is_multiple||this.selected_item.addClass("chzn-default"),this.show_search_field_default(),this.results_reset_cleanup(),this.form_field_jq.trigger("change");if(this.active_field)return this.results_hide()},i.prototype.results_reset_cleanup=function(){return this.current_value=this.form_field_jq.val(),this.selected_item.find("abbr").remove()},i.prototype.result_select=function(e){var t,n,r,i;if(this.result_highlight)return t=this.result_highlight,n=t.attr("id"),this.result_clear_highlight(),this.is_multiple?this.result_deactivate(t):(this.search_results.find(".result-selected").removeClass("result-selected"),this.result_single_selected=t,this.selected_item.removeClass("chzn-default")),t.addClass("result-selected"),i=n.substr(n.lastIndexOf("_")+1),r=this.results_data[i],r.selected=!0,this.form_field.options[r.options_index].selected=!0,this.is_multiple?this.choice_build(r):(this.selected_item.find("span").first().text(r.text),this.allow_single_deselect&&this.single_deselect_control_build()),(!e.metaKey&&!e.ctrlKey||!this.is_multiple)&&this.results_hide(),this.search_field.val(""),(this.is_multiple||this.form_field_jq.val()!==this.current_value)&&this.form_field_jq.trigger("change",{selected:this.form_field.options[r.options_index].value}),this.current_value=this.form_field_jq.val(),this.search_field_scale()},i.prototype.result_activate=function(e){return e.addClass("active-result")},i.prototype.result_deactivate=function(e){return e.removeClass("active-result")},i.prototype.result_deselect=function(t){var n,r;return r=this.results_data[t],this.form_field.options[r.options_index].disabled?!1:(r.selected=!1,this.form_field.options[r.options_index].selected=!1,n=e("#"+this.container_id+"_o_"+t),n.removeClass("result-selected").addClass("active-result").show(),this.result_clear_highlight(),this.winnow_results(),this.form_field_jq.trigger("change",{deselected:this.form_field.options[r.options_index].value}),this.search_field_scale(),!0)},i.prototype.single_deselect_control_build=function(){if(this.allow_single_deselect&&this.selected_item.find("abbr").length<1)return this.selected_item.find("span").first().after('<abbr class="search-choice-close"></abbr>')},i.prototype.winnow_results=function(){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y;this.no_results_clear(),f=0,l=this.search_field.val()===this.default_text?"":e("<div/>").text(e.trim(this.search_field.val())).html(),o=this.search_contains?"":"^",s=new RegExp(o+l.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i"),p=new RegExp(l.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i"),y=this.results_data;for(d=0,m=y.length;d<m;d++){n=y[d];if(!n.disabled&&!n.empty)if(n.group)e("#"+n.dom_id).css("display","none");else if(!this.is_multiple||!n.selected){t=!1,a=n.dom_id,u=e("#"+a);if(s.test(n.html))t=!0,f+=1;else if(this.enable_split_word_search&&(n.html.indexOf(" ")>=0||n.html.indexOf("[")===0)){i=n.html.replace(/\[|\]/g,"").split(" ");if(i.length)for(v=0,g=i.length;v<g;v++)r=i[v],s.test(r)&&(t=!0,f+=1)}t?(l.length?(c=n.html.search(p),h=n.html.substr(0,c+l.length)+"</em>"+n.html.substr(c+l.length),h=h.substr(0,c)+"<em>"+h.substr(c)):h=n.html,u.html(h),this.result_activate(u),n.group_array_index!=null&&e("#"+this.results_data[n.group_array_index].dom_id).css("display","list-item")):(this.result_highlight&&a===this.result_highlight.attr("id")&&this.result_clear_highlight(),this.result_deactivate(u))}}return f<1&&l.length?this.no_results(l):this.winnow_results_set_highlight()},i.prototype.winnow_results_clear=function(){var t,n,r,i,s;this.search_field.val(""),n=this.search_results.find("li"),s=[];for(r=0,i=n.length;r<i;r++)t=n[r],t=e(t),t.hasClass("group-result")?s.push(t.css("display","auto")):!this.is_multiple||!t.hasClass("result-selected")?s.push(this.result_activate(t)):s.push(void 0);return s},i.prototype.winnow_results_set_highlight=function(){var e,t;if(!this.result_highlight){t=this.is_multiple?[]:this.search_results.find(".result-selected.active-result"),e=t.length?t.first():this.search_results.find(".active-result").first();if(e!=null)return this.result_do_highlight(e)}},i.prototype.no_results=function(t){var n;return n=e('<li class="no-results">'+this.results_none_found+' "<span></span>"</li>'),n.find("span").first().html(t),this.search_results.append(n)},i.prototype.no_results_clear=function(){return this.search_results.find(".no-results").remove()},i.prototype.keydown_arrow=function(){var t,n;this.result_highlight?this.results_showing&&(n=this.result_highlight.nextAll("li.active-result").first(),n&&this.result_do_highlight(n)):(t=this.search_results.find("li.active-result").first(),t&&this.result_do_highlight(e(t)));if(!this.results_showing)return this.results_show()},i.prototype.keyup_arrow=function(){var e;if(!this.results_showing&&!this.is_multiple)return this.results_show();if(this.result_highlight)return e=this.result_highlight.prevAll("li.active-result"),e.length?this.result_do_highlight(e.first()):(this.choices>0&&this.results_hide(),this.result_clear_highlight())},i.prototype.keydown_backstroke=function(){var e;if(this.pending_backstroke)return this.choice_destroy(this.pending_backstroke.find("a").first()),this.clear_backstroke();e=this.search_container.siblings("li.search-choice").last();if(e.length&&!e.hasClass("search-choice-disabled"))return this.pending_backstroke=e,this.single_backstroke_delete?this.keydown_backstroke():this.pending_backstroke.addClass("search-choice-focus")},i.prototype.clear_backstroke=function(){return this.pending_backstroke&&this.pending_backstroke.removeClass("search-choice-focus"),this.pending_backstroke=null},i.prototype.keydown_checker=function(e){var t,n;t=(n=e.which)!=null?n:e.keyCode,this.search_field_scale(),t!==8&&this.pending_backstroke&&this.clear_backstroke();switch(t){case 8:this.backstroke_length=this.search_field.val().length;break;case 9:this.results_showing&&!this.is_multiple&&this.result_select(e),this.mouse_on_container=!1;break;case 13:e.preventDefault();break;case 38:e.preventDefault(),this.keyup_arrow();break;case 40:this.keydown_arrow()}},i.prototype.search_field_scale=function(){var t,n,r,i,s,o,u,a,f;if(this.is_multiple){r=0,u=0,s="position:absolute; left: -1000px; top: -1000px; display:none;",o=["font-size","font-style","font-weight","font-family","line-height","text-transform","letter-spacing"];for(a=0,f=o.length;a<f;a++)i=o[a],s+=i+":"+this.search_field.css(i)+";";return n=e("<div />",{style:s}),n.text(this.search_field.val()),e("body").append(n),u=n.width()+25,n.remove(),u>this.f_width-10&&(u=this.f_width-10),this.search_field.css({width:u+"px"}),t=this.container.height(),this.dropdown.css({top:t+"px"})}},i.prototype.generate_random_id=function(){var t;t="sel"+this.generate_random_char()+this.generate_random_char()+this.generate_random_char();while(e("#"+t).length>0)t+=this.generate_random_char();return t},i}(AbstractChosen),r.Chosen=t,n=function(e){var t;return t=e.outerWidth()-e.width()},r.get_side_border_padding=n}.call(this);

//wait until exists plugin
  
(function ($) {

/**
* @function
* @property {object} jQuery plugin which runs handler function once specified element is inserted into the DOM
* @param {function} handler A function to execute at the time when the element is inserted
* @param {bool} shouldRunHandlerOnce Optional: if true, handler is unbound after its first invocation
* @example $(selector).waitUntilExists(function);
*/

$.fn.waitUntilExists	= function (handler, shouldRunHandlerOnce, isChild) {
	var found	= 'found';
	var $this	= $(this.selector);
	var $elements	= $this.not(function () { return $(this).data(found); }).each(handler).data(found, true);
	
	if (!isChild)
	{
		(window.waitUntilExists_Intervals = window.waitUntilExists_Intervals || {})[this.selector] =
			window.setInterval(function () { $this.waitUntilExists(handler, shouldRunHandlerOnce, true); }, 500)
		;
	}
	else if (shouldRunHandlerOnce && $elements.length)
	{
		window.clearInterval(window.waitUntilExists_Intervals[this.selector]);
	}
	
	return $this;
}

}(jQuery));

$jq(document).ready(function() {
	if($jq("#tDescription").length > 0) {
		modifyHelpSpotInterface();
		createFormstackReferenceLink();
		createCustomizedTimeTrackingForm();

		$jq("#tTime").keyup(allowTimeLog);
		$jq("#time-tracker-log-time").click(clearActivitySelection);
  }

	if($jq("#streamViewTriage").length > 0) {
		addIntakeFormLinks();
	}
  getTotalEstimatedTime();

  $jq("button#time-tracker-log-time").click(function() {
    $jq('#estimated-total-time').waitUntilExists(computeThreshold);
  });
});

function getServiceAgreementBaseURL() {
  var environment = getHostEnvironment();
  var services_api = "";
  if (environment=="staging") {  //staging
    services_api = "http://services-staging.sc-ctsi.org/1/service_agreements/";
  }
  else if (environment=="production") {
    services_api = "http://services.sc-ctsi.org/1/service_agreements/";
  }
  return services_api;
}

function getServiceAgreementStatus() {
  var status = "New";
  var services_api;
  var project_id = $jq("div.box_title span.box_title_big").html(); //12951
  services_api = getServiceAgreementBaseURL();
  $jq.ajax({
    url: services_api + project_id,
    async: false,
    data: {
      format: 'json'
    },
    error: function() {
     console.log('An error calling the service_agreement API occurred');
    },
    dataType: 'json',
    success: function(data) {
      if (data.response.length > 0) {
        status = data.response[0]["status"];
      }
    }, 
    type: 'GET'
  });
  return status;
}

function getTotalEstimatedTime() {
  var project_id = $jq("div.box_title span.box_title_big").html(); //12951
  var services_api;
  var environment = getHostEnvironment();
  if (environment=="staging") {  //staging
    services_api = "http://services-staging.sc-ctsi.org/1/service_agreements/";
  }
  else if (environment=="production") {
    services_api = "http://services.sc-ctsi.org/1/service_agreements/";
  }
  $jq.ajax({
    url: services_api+project_id,
    data: {
      format: 'json'
    },
    error: function() {
     console.log('An error calling the service_agreement API occurred');
    },
    dataType: 'json',
    success: function(data) {
      if (data.response.length > 0) {
        var estimated_total_time = data.response[0]["estimated_total_time"];
        //console.log("Estimated total time: " + estimated_total_time);
        var clock_time =  $jq('form div.box_title #time-tracker-total').html();
        var clock = clock_time.split(":");
        var actual_hours =  parseFloat(clock[0]) + parseFloat(clock[1])/60.0;
        var remaining_time = (estimated_total_time - actual_hours).toFixed(2);
        //console.log("Remaining time: " + remaining_time);
        
        estimated_total_time = convertHoursToHourMinute(estimated_total_time);
        remaining_time = convertHoursToHourMinute(remaining_time);
        addTotalEstimatedTimeHTML(estimated_total_time, remaining_time);
      }
    }, 
    type: 'GET'
  });
  return "0:00";
}

function computeThreshold() {
  var project_id = $jq("div.box_title span.box_title_big").html(); //12951
  var services_api;
  var environment = getHostEnvironment();
  if (environment=="staging") {  //staging
    services_api = "http://services-staging.sc-ctsi.org/1/service_agreements/";
  }
  else if (environment=="production") {
    services_api = "http://services.sc-ctsi.org/1/service_agreements/";
  }
  var estimate = $jq('div#estimated-total-time').text();
  var time_regex = /\d+\:\d+/g;
  var match = estimate.match(/\d+\:\d+/g);
  var clock_time =  $jq('form div.box_title #time-tracker-total').html();
  var match2 = clock_time.match(/(\d+\:\d+)/g)
  var clock = match2[2].split(":");
  var clock2 = match[0].split(":");
  var actual_hours = parseFloat(clock[0]) + parseFloat(clock[1])/60.0;
  var estimated_total_time = parseFloat(clock2[0]) + parseFloat(clock2[1])/60.0;
  var remaining_time = (estimated_total_time - actual_hours).toFixed(2);
  var percent = remaining_time / estimated_total_time;
  if (percent <= 0.10 ) {
    $jq.ajax({
      url: services_api+"time_threshold_email?project_id=" + project_id,
      data: {
        format: 'json'
      },
      error: function() {
       console.log('An error calling the service_agreement API occurred');
      },
      dataType: 'json',
      success: function(data) {
        alert('Actual time spent is within 10% of Total Estimated Time or has exceeded it.  An email has been sent to PET@sc-ctsi.org');
      }, 
      type: 'GET'
    });
  }
}
function convertHoursToHourMinute(time) {
  var result = "";
  if (time < 0) {
    result = result + "-";
  }
  time = Math.abs(time);
  var hours = Math.floor(time);
  var minutes = Math.round((time-hours)*60);
  result = result + zeroPad(hours, 2) + ":" + zeroPad(minutes, 2);
  return result;
}

function zeroPad(num, size) {
    var s = num+"";
    while (s.length < size) s = "0" + s;
    return s;
}

function addTotalEstimatedTimeHTML(estimated_total_time, remaining_time) {
  // total time estimated HTML
  var html = '';
  html = "<div id='estimated-total-time'>Total Estimated Time: " + estimated_total_time + "</div>" + "<div id='remaining-time'>Remaining Time: " + remaining_time + "</div><span>Time Elapsed: </span>" ;
  var section1 = $jq('form div.box_title span#estimated-total-time');
  var section2 = $jq('form div.box_title #time-tracker-total');
  if (section1.length > 0 ) {
    section1.replaceWith(html);
  }
  else if (section2.length > 0 ) {
    section2.prepend(html);
  }
}

function addIntakeFormLinks() {
	var uniqueIdColumnIndex;

	if ($jq('#ws_datatable tr td').filter(function(){return $jq(this).attr('id') == '1_table_header_Custom8';}).index() != -1) {
		uniqueIdColumnIndex = $jq('#ws_datatable tr td').filter(function(){return $jq(this).attr('id') == '1_table_header_Custom8';}).index() + 1;
	}

	// if ($jq("span.table-title").text() == "My Queue") {
	// 	uniqueIdColumnIndex = 9;
	// }
	// if ($jq("span.table-title").text() == "Inbox") {
	// 	uniqueIdColumnIndex = 8;
	// }

	$jq("#ws_datatable table tr.tablerowoff td:nth-child(" + uniqueIdColumnIndex + ")").each(function(index, value) {
		// Ignore the first two rows in the inbox table
		var formstackViewLink = 'https://www.formstack.com/admin/submission/view/' + $jq(value).text() + '/631134?share=47XU7x6Q7f';
		$jq(value).html("<a class='formstack-reference-link' target='_blank' href='" + formstackViewLink + "'>View intake form</a>");
	});
	$jq("#ws_datatable table tr.tablerowon td:nth-child(" + uniqueIdColumnIndex + ")").each(function(index, value) {
		// Ignore the first two rows in the inbox table
		var formstackViewLink = 'https://www.formstack.com/admin/submission/view/' + $jq(value).text() + '/631134?share=47XU7x6Q7f';
		$jq(value).html("<a class='formstack-reference-link' target='_blank' href='" + formstackViewLink + "'>View intake form</a>");
	});
}

function clearActivitySelection() {
	if ($jq("#Custom5").val() == '') { 
		$jq("#empty_charge_category_warning").css('visibility', 'visible');
	};
	$jq(".chosen").val('').trigger("liszt:updated");
	$jq("#time-tracker-log-time").hide();
  getTotalEstimatedTime();
}

function createCustomizedTimeTrackingForm() {
	if($jq("#custom_time_tracking").length > 0) {
		$jq("#custom_time_tracking").remove();
	}

	var activities = ["Study Design", "Statistical Analysis Plan", "Data Cleaning & Management", "Final Data Sharing Plan", "Analysis & Statistical Reports", "Statistical or Database Training", "Background research - Consultant Knowledge Base", "Background research - Project-related", "Pre-April 2013: activity unknown"];
	var activityDetails = ["Meeting with Client", "Study design", "Power/sample size", "Statistical analysis plan", "Data acquisition plan", "Randomization Schema", "Perform statistical analysis", "Scientific writing", "Review study materials", "Responding to reviewers", "Statistical training (individual)", "Statistical training (group)", "REDCap help", "Tables/Figures"];

	html = '';
	html = '<form id="custom_time_tracking">';
	
	html += '<div id="empty_charge_category_warning" style="display:block; visibility: hidden; padding:5px; background:#FFAAAA; margin-bottom:5px; border-radius:5px;">WARNING: Please make sure that you enter a Charge Category for this request.</div>'
	html += getActivitiesHtml(activities);
	html += getActivityDetailsHtml(activityDetails);

	html += '</form>';

	$jq("#tDescription").parent().prepend(html);

	$jq("#activities").chosen().change(onActivityOrActivityDetailsChanged);
	$jq("#activity_details").chosen().change(onActivityOrActivityDetailsChanged);
}

function allowTimeLog() {
	if($jq("#tTime").val() == "" || $jq("#tTime").val() == "hh:mm" || $jq('#activities :selected').length == 0)
	{
		$jq("#time-tracker-log-time").hide();
		return;
	}

	$jq("#time-tracker-log-time").show();
}

function onActivityOrActivityDetailsChanged() {
	allowTimeLog();
	var description = "Activity: ";

	$jq('#activities :selected').each(function(i, selected){ 
  		description += $jq(selected).text(); 
  		description += "; ";
	});

	description += " Activity Details: ";
	$jq('#activity_details :selected').each(function(i, selected){ 
  		description += $jq(selected).text(); 
  		description += ";";
	});

	// If Non-SC CTSI checkbox is checked, add (Non-SC CTSI Consultation) to description
	if ($jq('#Custom10').is(':checked')) {
		description += " (Non-SC CTSI Consultation)";
	}

	$jq("#tDescription").val(description);
}

function modifyHelpSpotInterface() {
	var host = window.location.hostname;
  var environment = getHostEnvironment();
	// Hide and disable HelpSpot time tracking elements that we don't need.
	$jq(".timetracker-billable").hide();
	$jq("#timerimg").hide();
	$jq("#time-tracker-log-time").hide();
	$jq("#empty_charge_category_warning").hide();
	$jq("#tDescription").attr("readonly", true);

	// WARNING: The names of the fields are dependent on the HelpSpot install and the IDs of the custom fields.
	// Staging (eHome HelpSpot Install)
	if (host.toLowerCase().indexOf("support.sc-ctsi.org") != -1) {
		$jq("#Custom2").attr("readonly", true);
		$jq("#Custom3").attr("readonly", true);
	}

	// Production (BBR HelpSpot Install)
	if (environment!="unknown") {
		$jq("#Custom7").attr("readonly", true);
		$jq("#Custom8").attr("readonly", true);
	}
}

function getActivitiesHtml(activities) {
	// Activities Select HTML
	var html = '';

	html += '<select id="activities" class="chosen" multiple="true" data-placeholder="Activity (Select all that Apply)">';
	for(var i = 0; i < activities.length; i++) {
		html += '<option value="' + activities[i] + '">' + activities[i] + '</option>';
	}
	html += '</select>';

	return html;
}

function getActivityDetailsHtml(activityDetails) {
	// Activity Details Select HTML
	var html = '';

	html += '<select class="chosen" multiple="true" id="activity_details" data-placeholder="Activity Details (Select all that Apply)">';
	for(var i = 0; i < activityDetails.length; i++) {
		html += '<option value="' + activityDetails[i] + '">' + activityDetails[i] + '</option>';
	}
	html += '</select>';

	return html;
}

function getHostEnvironment() {
  var host = window.location.hostname;
  var environment = "unknown";
  if (host.toLowerCase().indexOf("216.243.140.202") != -1) { //production
    environment = "production";
  }
  else if (host.toLowerCase().indexOf("216.243.141.55") != -1) { //staging
    environment = "staging";
  }
  return environment;
}

function createFormstackReferenceLink() {
	var host = window.location.hostname;

	// The uniqueId uniquely identifies a form submission across Formstack
	var formstackViewLink = "";
	var formstackEditLink = "";
	var serviceAgreementEditLink = "";
	var satisfactionSurveyLink = "";
  var serviceAgreementLinkMsg = "Prepare service agreement";
  var serviceAgreementStatus = getServiceAgreementStatus();
  var encodedParams = "?view_type=consultant";


  if (serviceAgreementStatus=="Finalized"||serviceAgreementStatus=="Accepted"||serviceAgreementStatus=="Rejected") {
    serviceAgreementLinkMsg = "View service agreement";
  }
  
	// Staging (eHome HelpSpot Install)
	if (host.toLowerCase().indexOf("support.sc-ctsi.org") != -1) {
		var formId = $jq("#Custom2").val();
		var uniqueId = $jq("#Custom3").val();
		// The /575805 is a proprietary number added at the end of a view link by Formstack per form. It is NOT equal to the FormID
		formstackViewLink = 'https://www.formstack.com/admin/submission/view/' + uniqueId + '/575805';
	}

	// Production (BBR HelpSpot Install)
	if (host.toLowerCase().indexOf("216.243.140.202") != -1) {
		var formId = $jq("#Custom7").val();
		var uniqueId = $jq("#Custom8").val();
		var projectId = $jq('.box_title_big').text();
		var assignedToName = $jq('.request-assignedto-name').text();

		// The /631134 is a proprietary number added at the end of a view link by Formstack per form. It is NOT equal to the FormID
		formstackViewLink = 'https://www.formstack.com/admin/submission/view/' + uniqueId + '/631134?share=47XU7x6Q7f';
		formstackEditLink = 'https://www.formstack.com/admin/submission/edit/' + uniqueId + '/S631134';
		serviceAgreementEditLink = 'http://s.sc-ctsi.org/service_agreements/new/' + uniqueId + '/' + projectId + '/' + assignedToName + encodedParams;
		satisfactionSurveyLink = 'http://services.sc-ctsi.org/satisfaction_surveys/new/' + uniqueId + '/' + projectId + '/' + assignedToName;
	}

  // Staging (BBR HelpSpot Install) - Added 4/15/15 Weds
  if (host.toLowerCase().indexOf("216.243.141.55") != -1) {
    var formId = $jq("#Custom7").val();
    var uniqueId = $jq("#Custom8").val();
    var projectId = $jq('.box_title_big').text();
    var assignedToName = $jq('.request-assignedto-name').text();

    // The /631134 is a proprietary number added at the end of a view link by Formstack per form. It is NOT equal to the FormID
    formstackViewLink = 'https://www.formstack.com/admin/submission/view/' + uniqueId + '/631134?share=47XU7x6Q7f';
    formstackEditLink = 'https://www.formstack.com/admin/submission/edit/' + uniqueId + '/S631134';
		serviceAgreementEditLink = 'http://s.sc-ctsi.org/service_agreements/new/' + uniqueId + '/' + projectId + '/' + assignedToName + encodedParams;
    satisfactionSurveyLink = 'http://services-staging.sc-ctsi.org/satisfaction_surveys/new/' + uniqueId + '/' + projectId + '/' + assignedToName;
  }
	$jq("#customer_tab").append("<a class='formstack-reference-link' target='_blank' href='" + formstackViewLink + "'>View intake form</a>");
	$jq("#customer_tab").append("<a class='formstack-reference-link' target='_blank' href='" + formstackEditLink + "'>Edit intake form (Login required)</a>");
	$jq("#customer_tab").append("<a onclick=\"return confirm('" + serviceAgreementLinkMsg + "')\" class='formstack-reference-link' target='_blank' href='" + serviceAgreementEditLink + "'>Test Link</a>");
	$jq("#customer_tab").append("<a onclick=\"return confirm('Send Satisfaction Survey?')\" class='formstack-reference-link' target='_blank' href='" + satisfactionSurveyLink + "'>Send Satisfaction Survey</a>");
}
